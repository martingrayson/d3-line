<!DOCTYPE html>
<meta charset="utf-8">

<head>
    <link href="assets/css/line.css" rel="stylesheet" type="text/css">
    <script src="http://d3js.org/d3.v3.min.js"></script>
</head>

<body>

    <div id="line-chart">
        <svg>
        </svg>
    </div>

    <script>
        /*
         * Our standard data array object.
         */
        var dataArray = [{
            "name": "Foo Fighters",
            "class": "artist",
            "data": [{
                "salesWindowPercentage": "0",
                "value": "5"
            }, {
                "salesWindowPercentage": "20",
                "value": "55"
            }, {
                "salesWindowPercentage": "70",
                "value": "30"
            }, {
                "salesWindowPercentage": "90",
                "value": "10"
            }]
        }, {
            "name": "Rob Zombie",
            "class": "artist",
            "data": [{
                "salesWindowPercentage": "30",
                "value": "10"
            }, {
                "salesWindowPercentage": "50",
                "value": "20"
            }, {
                "salesWindowPercentage": "80",
                "value": "30"
            }, {
                "salesWindowPercentage": "100",
                "value": "40"
            }]
        }, {
            "name": "Rock",
            "class": "genre",
            "data": [{
                "salesWindowPercentage": "20",
                "value": "5"
            }, {
                "salesWindowPercentage": "55",
                "value": "10"
            }, {
                "salesWindowPercentage": "82",
                "value": "40"
            }, {
                "salesWindowPercentage": "90",
                "value": "45"
            }]
        }];

        /*
         * ***************
         * Config values
         * ***************
         */
        var margin = {
                top: 80,
                right: 150,
                bottom: 80,
                left: 80
            },
            width = 600 - margin.left - margin.right,
            height = 350 - margin.top - margin.bottom;

        // Set our colour scale.
        var colors = d3.scale.ordinal().range(["#0299A3", "#EA0087", "#FFD119", "#213975", "#EA8522"]);

        // Setup our data
        var seriesArray = processSeriesData(dataArray);

        /*
         * ***************
         * Draw each component
         * ***************
         */
        var xScale = d3.scale.linear().range([0, width]),
            yScale = d3.scale.linear().range([height, 0]);

        var xAxis = d3.svg.axis()
            .scale(xScale)
            .ticks(11);

        var yAxis = d3.svg.axis()
            .scale(yScale)
            .ticks(5)
            .orient("left");

        // A line generator, for the dark stroke.
        var line = d3.svg.line()
            .interpolate("monotone")
            .x(function(d) {
                return xScale(d[0]);
            })
            .y(function(d) {
                return yScale(d[1]);
            });

        // Set the scale values.
        xScale.domain([0, 100]);
        yScale.domain(
            [
                d3.min(seriesArray, function(series) {
                    return 0; //return series.range.y[0]
                }),
                d3.max(seriesArray, function(series) {
                    return (
                        Math.round(d3.max(seriesArray, function(series) { return series.range.y[1];})/10))*10;
                })
            ]);

        //Draw stuff
        var svg = d3.select("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        // Add the clip path.
        svg.append("clipPath")
            .attr("id", "clip")
            .append("rect")
            .attr("width", width)
            .attr("height", height);

        // Add the x-axis.
        svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis);

        // Add x-axis label
        svg.append("text")
            .attr("class", "axis-label")
            .attr("text-anchor", "middle")
            .attr("x", width / 2)
            .attr("y", height + (margin.bottom / 2) + 10) //why +10
            .text("Percentage through sales window");

        // Add the y-axis.
        svg.append("g")
            .attr("class", "y axis")
            .call(yAxis);

        // Y-axis label
        svg.append("text")
            .attr("class", "axis-label")
            .attr("text-anchor", "middle")
            .attr("x", -(width / 4))
            .attr("y", -(margin.left / 2) - 10)
            .attr("transform", "rotate(-90)")
            .text("Percentage of total tickets sold");

        // Draw our lines
        svg.selectAll('.line')
            .data(seriesArray)
            .enter()
            .append('path')
            .attr('class', function(d) {
                return d.class + ' line'
            })
            .style('stroke', function(d) {
                return colors(Math.random() * 50);
            })
            .attr('clip-path', 'url(#clip)')
            .attr('d', function(d) {
                return line(d.data);
            })

        // Draw legend
        var legend = svg.selectAll(".legend")
            .data(colors.domain())
            .enter().append("g")
            .attr("class", "legend")
            .attr("transform", function(d, i) {
                return "translate(0," + i * 20 + ")";
            });

        // Draw legend colored rectangles
        legend.append("rect")
            .attr("x", width + (margin.right - 18 - 10))
            .attr("width", 18)
            .attr("height", 18)
            .style("fill", colors);

        // Draw legend text
        legend.append("text")
            .attr("x", width + (margin.right) - 18 - 10 - 10)
            .attr("y", 8)
            .attr("dy", ".55em")
            .style("text-anchor", "end")
            .attr("class", function(d, i) {
                return 'legend-label ' + seriesArray[i].class;
            })
            .text(function(d, i) {
                return (seriesArray[i].class == 'genre' ? seriesArray[i].name + ' (avg)' : seriesArray[i].name);
            })

        // Add rectangle to hide entire graph
        var curtain = svg.append('rect')
            .attr('x', -1 * (width + 1))
            .attr('y', -1 * (height - 1))
            .attr('height', height)
            .attr('width', width)
            .attr('class', 'curtain')
            .attr('transform', 'rotate(180)')
            .style('fill', '#ffffff')

        var t = svg.transition()
            .delay(500)
            .duration(5000)
            .ease('linear')
            .each('end', function() {
                d3.select('line.guide')
                    .transition()
                    .style('opacity', 0)
                    .remove()
            });

        t.select('rect.curtain')
            .attr('width', 0);

        /*
         * ***************
         * Helper functions
         * ***************
         */
        function processSeriesData(inputDataArray) {
            // Read our data
            var seriesArray = [];
            inputDataArray.forEach(function(dataSeries) {

                var currentSeriesName = dataSeries.name;
                var currentSeriesData = dataSeries.data;
                var currentSeriesClass = dataSeries.class;
                var standardSeriesData = [];

                for (var i = 0; i < currentSeriesData.length; i++) {
                    var currentDataItem = currentSeriesData[i];

                    // scale it here too.
                    var currentDataCoord = [currentDataItem.salesWindowPercentage, currentDataItem.value];
                    standardSeriesData.push(currentDataCoord);
                }

                var rangeXCoords = d3.extent(standardSeriesData, function(d) {
                    return d[0];
                });
                var rangeYCoords = d3.extent(standardSeriesData, function(d) {
                    return d[1];
                });

                var series = {
                    "name": currentSeriesName,
                    "class": currentSeriesClass,
                    "range": {
                        "x": rangeXCoords,
                        "y": rangeYCoords
                    },
                    "data": standardSeriesData
                };
                seriesArray.push(series);
            });

            return seriesArray;
        }
    </script>